---
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
# load library
library(rvest)
library(ggplot2)
library(FinCal)
```

```{r echo=FALSE}
stock = "CVS"
```

```{r echo=FALSE}
# Custom Functions
convert <- function(x) {
  x <- gsub('[(]',"-",x)
  x <- gsub('[)]',"",x)
  if (grepl("B", x)) {
    x <- gsub('[B]',"",x) 
    x <- as.double(x)
    x*1000
  } else if (grepl("M", x)) {
    x <- gsub('[M]',"",x)
    x <- as.double(x) 
    x*1
  } else if (grepl("-", x)) {
    x <- gsub('-',"0",x)
    x <- as.double(x)
  }
}
```

```{r echo=FALSE}
# Scrape Financial data
income_statement <- paste0('https://www.marketwatch.com/investing/stock/',stock,'/financials')
income_statement_page <- income_statement %>% read_html()
balance_sheet <- paste0('https://www.marketwatch.com/investing/stock/',stock,'/financials/balance-sheet')
balance_sheet_page <- balance_sheet %>% read_html()
cash_flow <- paste0('https://www.marketwatch.com/investing/stock/',stock,'/financials/cash-flow')
cash_flow_page <- cash_flow %>% read_html()
more_stats <- paste0("https://finviz.com/quote.ashx?t=",stock)
more_stats_page <- more_stats %>% read_html()

income_names <- income_statement_page %>% html_nodes(".overflow__cell .fixed--cell") %>% html_text()
income_nums <- income_statement_page %>% html_nodes(".cell__content span") %>% html_text()
balance_names <- balance_sheet_page %>% html_nodes(".overflow__cell .fixed--cell") %>% html_text()
balance_nums <- balance_sheet_page %>% html_nodes(".cell__content span") %>% html_text()
cash_names <- cash_flow_page %>% html_nodes(".overflow__cell .fixed--cell") %>% html_text()
cash_nums <- cash_flow_page %>% html_nodes(".cell__content span") %>% html_text()
stats_names <- more_stats_page %>% html_nodes(".snapshot-td2-cp") %>% html_text()
stats_nums <- more_stats_page %>% html_nodes(".snapshot-td2 b") %>% html_text()

x<-1
while (income_names[x] != "Sales/Revenue") {x<-x+1}
Revenue <- income_nums[(5*(x-1)+1):(5*x)]
for(i in 1:5){
  Revenue[i] <- convert(Revenue[i])
}
x<-1
while (balance_names[x] != "Total Equity") {x<-x+1}
  Equity <- balance_nums[(5*(x-1)+1):(5*x)]
for(i in 1:5){
  Equity[i] <- convert(Equity[i])
}
Equity <- as.numeric(Equity)
x<-1
while (balance_names[x] != "Long-Term Debt") {x<-x+1}
Debt <- balance_nums[(5*(x-1)+1):(5*x)]
for(i in 1:5){
  Debt[i] <- convert(Debt[i])
}
Debt <- as.numeric(Debt)
DebtToEquity = Debt/Equity
x<-1
while (cash_names[x] != "Free Cash Flow") {x<-x+1}
Free_Cash_Flow <- cash_nums[(5*(x-1)+1):(5*x)]
for(i in 1:5){
  Free_Cash_Flow[i] <- convert(Free_Cash_Flow[i])
}
Free_Cash_Flow <- as.numeric(Free_Cash_Flow)
x<-1

#Valuation data
while (income_names[x] != "EPS (Basic)") {x<-x+1}
EPS <- income_nums[(5*x)]
EPS <- as.double(EPS)
x<-1
while (stats_names[x] != "P/E") {x<-x+1}
PE <- stats_nums[x] %>% as.double()
x<-1
while (stats_names[x] != "Price") {x<-x+1}
price <- stats_nums[x] %>% as.double()


```


## Stock Analysis of `r stock`

## Plots

```{r pressure, echo=FALSE}
#plot(DebtToEquity)
```

```{r, echo=FALSE}
df <- data.frame (
  year = 1:5,
  Revenue = Revenue,
  DebtToEquity = DebtToEquity
)
ggplot(df, aes(Revenue, year)) +
      geom_bar(stat="identity", fill = 'blue', color = "black", alpha = 0.8) +
      geom_text(aes(label=Revenue), vjust = -0.3) +
      ylab("ylabel")
```

```{r, echo=FALSE}
ggplot(df, aes(year, DebtToEquity)) +
  geom_line(col="red") + geom_point(size=3, col="red") +
  #geom_text(label=round(DebtToEquity,2)) +
  geom_hline(yintercept = 1) +
  annotate("text", x=2, y=1.01, label='"Good" Debt to Equity') +
  theme_bw()
```
```{r echo=FALSE}
r = 0.08
buyprice1 = EPS*(1+r)*PE
```

Current Price: `r price`  
Estimated Buy Price: `r buyprice1`
